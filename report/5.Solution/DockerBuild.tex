\section{Build process}\label{sec:buildprocess}
In previous semesters, the build process has been straightforward, as it has simply been using the tool included with the IDE of choice for the chosen language.
This semester the build process is quite a bit more complicated, as the project targets the NXT.
This complicates the build process for a number of reasons:
nxtOSEK is the operating system for NXT, for RTS on the NXT, even if it is quite old, the latest release, as of the writing of this report, being in January of 2013\cite{osekrelease}.

During the groups testing of the nxtOSEK build, it was found that it was largely incompatible with modern operating systems, both Windows, OS X and a number of modern Linux distributions.
According to the latest documentation on the nxtOSEK webpage, the latest supported version of Linux is Ubuntu 11.10.
This complicated things a bit, as none of the group members were interested in installing such an old operating system on their personal computer.

Instead, the group looked at Docker.
\subsection{Docker}\label{subsec:docker}
Docker is a way to deploy a consistent environment for applications to run in, also known as containerization\cite{dockerdocstart}.
A Docker deployment consists of two different concepts, the container and an image.
\begin{description}
    \item [Images] are executables that includes all the required information to instantiate containers.
    \item[Containers] are the runtime instances of an image, the running process of an image.
\end{description}

A Docker container is almost the same as a virtual machine, although a Docker container only uses the required resources, while a virtual machine is allowed access to more resources than is typically needed.
Docker runs natively on Linux, and takes no more memory than other executables.

A Docker deployment consists of two different concepts, the container and an image.
\begin{description}
    \item[Images] are executables that includes all the required information to instantiate containers.
    \item[Containers] are the runtime instances of an image, the running process of an image.
\end{description}
The concept of containerization as a way to ensure consistency in deployment of software, was perfect for the purposes of the group.
Docker is supported on all 3 major platform, and while both Docker for Windows and OSX run in a virtual machine, this is a non-issue.

A potential issue was nxtOSEK not being officially supported past Ubuntu 11.10, and Docker officially supporting Ubuntu 18.04, 16.04 and 14.04 /cite{dockerubuntu}.
However, a quick test proved that nxtOSEK still worked fine on Ubuntu 14.04.

\subsection{Docker implementation}\label{subsec:dockerimplementation}
The actual docker build process is a little obscure.

The first step is relatively straight forward with \textit{FROM ubuntu:14.04} simply specifying which version of Ubuntu to use.
The next bit simply installs the packages required by nxtOSEK.
\begin{lstlisting}[language=docker,label={lst:dockerimplementation1},caption={Version definition and installation of packages required by nxtOSEK}]
    FROM ubuntu:14.04

    # Install required packages listed by nxtOSEK
    RUN apt-get update
    RUN apt-get -y install tk-dev ncurses-dev libmpfr-dev wget gzip tar software-properties-common xvfb
\end{lstlisting} 

The next part is the most obscure part, as wine is installed to be able to run Windows programs.
This is done as the tool to build OIL files, only exists for Windows.
NeXT Tools is an utility program that includes various utilities for use with nxtOSEK, including an enhanced OIL file compile\cite{nxttool}.
It also includes an additional osek requirement, texinfo, which is the official GNU documentation format\cite{texinfo}.

\begin{lstlisting}[language=docker,label={lst:dockerimplementation2},caption={Reee}]

    # Install wine
    RUN dpkg --add-architecture i386
    RUN wget -nc https://dl.winehq.org/wine-builds/Release.key
    RUN apt-key add Release.key
    RUN apt-add-repository https://dl.winehq.org/wine-builds/ubuntu/
    RUN apt-get -y install apt-transport-https
    RUN apt-get update
    RUN apt-get -y install --install-recommends winehq-staging
    
    # Download a specific version of texinfo, the one in 14.04 
    # sources is not compatible with the expected version
    RUN wget http://ftp.gnu.org/gnu/texinfo/texinfo-4.13.tar.gz
    RUN gzip -dc < texinfo-4.13.tar.gz tar -xf -
    RUN cd texinfo-4.13 \&\& ./configure \&\& make \&\& make install
\end{lstlisting} 
Next, the ARM tool chain is installed.
The tool chain is used by nxtOSEK to build for the ARM7 CPU in the NXT.
\begin{lstlisting}[language=docker,label={lst:dockerimplementation3},caption={Reee}]
    # Build arm toolchain from nxtOSEK
    COPY build_arm_toolchain.sh home/
    RUN chmod 755 home/build_arm_toolchain.sh
    RUN home/build_arm_toolchain.sh
    
    # Add build.sh
    WORKDIR /home/nxtosek
    COPY build.sh ./
    RUN chmod 755 ./build.sh
\end{lstlisting}

Finally the nxtOSEK files are moved to the home folder, as cleanup, before the entry point for the container is set to the location in the home folder.
This means that whenever the Docker image is run, any arguments are passed along to the build file in the home directory.

\begin{lstlisting}[language=docker,label={lst:dockerimplementation4},caption={Reee}]   
    # Move nxtOSEK files to home folder
    RUN useradd nxtosek
    RUN usermod --password $(echo nxtosek openssl passwd -1 -stdin) nxtosek
    RUN chown -R nxtosek ./
    USER nxtosek
    ENV HOME /home/nxtosek
    ADD nxtOSEK.tar.xz ./
    ADD ecrobot.mak nxtOSEK/ecrobot
    
    # Set build.sh as entrypoint to execute when executing docker container
    ENTRYPOINT ["/home/nxtosek/build.sh"]
    CMD []    
\end{lstlisting}
It is important to mention that all of the downloaded files are cached, so the setup is not run every single time, and a cached version is used instead.

The Docker container allows the group to easily build the NXT implementation from any machine, as long as Docker supports the OS.
The Docker image is hosted publicly on the Docker hub at \url{https://hub.docker.com/r/teknight/nxtosek/}.

In addition to local builds, the Docker image is also hosted on the TeamCity server, as part of the continuous integration for the project, meaning that the Docker image is run every time something is pushed to a branch.
%Maybe describe Continuous integration?


